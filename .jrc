# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Author: Alex Guo
# Contact: chessnut@outlook.com
# Program: JARVIS.
# Purpose: Significantly speed up CLI.

JARVIS_HOME=$PWD

function jarvis_cd {
  cd $1;
  if [[ -n "$2" ]]
  then
    cd $2
  fi

  echo -e "${green}"$PWD"${endColor}"
}

function jarvis_open {
  echo ${1}
  ${EDITOR:-vim} ${1}
  #vim /home/ec2-user/space/jarvis2/README.md
}

function jarvis_jump {
  touch $JARVIS_HOME"/.jarvis"
  green='\e[0;32m'
  blue='\e[1;34m'
  endColor='\e[0m'
  declare toEdit

  while read line
  do
    # Kudos to @jsks for suggesting the following hack, which cleaned up the code quite a bit!
    to=${line#*\=}
    name=${line%\=*}

    if [[ "$name" == "$1" ]];
    then
      # Credit to MrGreen for supplying the following file logic.
      [[ -f "$to" ]] && break
      [[ -d "$to" ]] && jarvis_cd $to $2
      return
    fi
  done < $JARVIS_HOME"/.jarvis"

  [[ -f "$to" ]] && [[ "$name" == "$1" ]] && jarvis_open $to
}

function jarvis_all {
  green='\e[0;32m'
  endColor='\e[0m'

  # Credit to Mr Green from ArchLinux for suggesting the following code.
  echo -e "${green}\c"
  while read line
  do
    echo ${line}
  done < $JARVIS_HOME"/.jarvis"
  echo -e "${endColor}\c"
}

function jarvis_add {
  touch $JARVIS_HOME"/.jarvis"
  cur_alias=""

  if [[ -n "$2" ]]
  then
    cur_alias=$2
  else
    echo "Type an alias for the current working directory, or ^C to quit:"
    read cur_alias
  fi

  echo $cur_alias"="$PWD >> $JARVIS_HOME"/.jarvis"
  echo "\""$cur_alias"\" added as a bookmark."
}

function jarvis_update {
  SRC_URL='https://github.com/mallochine/jarvis2/raw/master'
  wget -r -q $SRC_URL"/.jrc" -O $JARVIS_HOME"/.jrc"
  . $JARVIS_HOME"/.jrc"
  echo "Updated."
}

# allow $EDITOR if set
# Credit to Mr Green and @jsks.
function jarvis_edit {
  file=$2
  if [[ -n "$file" ]]
  then
    echo "Type an alias you to add, or ^C to quit:"
    read file_alias
    echo $file_alias"="$PWD"/"$file >> $JARVIS_HOME"/.jarvis"
    echo "\""$file_alias"\" added as a bookmark."
  else
    ${EDITOR:-vim} $JARVIS_HOME"/.jarvis"
  fi
}

# Kudos to Mr Green for the following code.
function jarvis_delete {
  delete_alias=""
  if [[ -n "$2" ]]
  then
    delete_alias=$2
  else
    echo "Type an alias you wish to delete, or ^C to quit:"
    read delete_alias
  fi

  # now find the alias you wish to delete
  sed -i "/^${delete_alias}=/d" $JARVIS_HOME"/.jarvis"
  echo "\"${delete_alias}\" deleted."
}

function jarvis_main {
  cmd=${1}

  case $cmd in
  "add"|"+") jarvis_add $@;;
  "all") jarvis_all;;
  "update") jarvis_update;;
  "edit"|"vim") jarvis_edit $@;;
  "del"|"-") jarvis_delete $@;;
  *) jarvis_jump $@;;
  esac

  # set -f and set +f are needed so that we can actually listen
  # to what the user is trying to say, such as j rm *, instead
  # of having bash automatically expand that for us.
  set +f
}

alias j="set -f; jarvis_main"
